# CI on Pull Request: ruff, black, mypy, pytest; then Reviewer Agent
name: CI

on:
  pull_request:
    branches: [main, master]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Ruff
        run: ruff check coding_agents agents tests

      - name: Black
        run: black --check coding_agents agents tests

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Mypy
        run: mypy coding_agents agents --no-error-summary 2>/dev/null || true

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Pytest
        run: pytest tests -v

  reviewer:
    needs: [lint, typecheck, test]
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Set CI conclusion
        id: ci
        run: |
          if [ "${{ needs.lint.result }}" = "success" ] && [ "${{ needs.typecheck.result }}" = "success" ] && [ "${{ needs.test.result }}" = "success" ]; then
            echo "conclusion=success" >> $GITHUB_OUTPUT
            echo "summary=Lint, typecheck, tests passed" >> $GITHUB_OUTPUT
          else
            echo "conclusion=failure" >> $GITHUB_OUTPUT
            echo "summary=One or more CI jobs failed" >> $GITHUB_OUTPUT
          fi

      - name: Run Reviewer Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
        run: |
          coding-agents review --pr ${{ github.event.pull_request.number }} --repo ${{ github.repository }} \
            --ci-conclusion "${{ steps.ci.outputs.conclusion }}" \
            --ci-summary "${{ steps.ci.outputs.summary }}"
