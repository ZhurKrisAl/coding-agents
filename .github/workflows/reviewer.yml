# Standalone Reviewer Agent: can be triggered by workflow_run after CI (alternative to ci.yml reviewer job)
name: Reviewer Agent

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main, master]

jobs:
  reviewer:
    if: github.event.workflow_run.conclusion != 'cancelled'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: read
      actions: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Get PR number from workflow run
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_JSON='${{ toJson(github.event.workflow_run.pull_requests) }}'
          PR_NUM=$(echo "$PR_JSON" | jq -r '.[0].number // empty')
          echo "number=${PR_NUM:-0}" >> $GITHUB_OUTPUT

      - name: Run Reviewer Agent
        if: steps.pr.outputs.number != '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
        run: |
          coding-agents review --pr ${{ steps.pr.outputs.number }} --repo ${{ github.repository }} \
            --ci-conclusion "${{ github.event.workflow_run.conclusion }}" \
            --ci-summary "CI: ${{ github.event.workflow_run.conclusion }}"
